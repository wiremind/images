name: Security Scan

on:
  workflow_run:
    workflows: ["Build with Bake"]
    types: [completed]
    branches: [main]
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: "0 0 * * 0"
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  discover-images:
    # Only run if build workflow succeeded (or on schedule/manual trigger)
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has_images: ${{ steps.matrix.outputs.has_images }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build matrix from all images
        id: matrix
        run: |
          MATRIX_INCLUDES=()

          for bake_file in images/*/docker-bake.hcl; do
            if [ -f "$bake_file" ]; then
              image_dir=$(dirname "$bake_file")

              # Use bake --print to get all tags
              TAGS=$(docker buildx bake --file "$bake_file" --print 2>/dev/null | \
                jq -r '.target[].tags[]' 2>/dev/null || true)

              for tag in $TAGS; do
                if [ -n "$tag" ]; then
                  MATRIX_INCLUDES+=("{\"image\":\"$tag\"}")
                fi
              done
            fi
          done

          if [ ${#MATRIX_INCLUDES[@]} -eq 0 ]; then
            echo "has_images=false" >> $GITHUB_OUTPUT
            echo 'matrix={"include":[]}' >> $GITHUB_OUTPUT
          else
            MATRIX_JSON=$(printf '%s\n' "${MATRIX_INCLUDES[@]}" | jq -s -c '{include: .}')
            echo "has_images=true" >> $GITHUB_OUTPUT
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
            echo "Matrix: $MATRIX_JSON"
          fi

  scan:
    needs: discover-images
    if: needs.discover-images.outputs.has_images == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover-images.outputs.matrix) }}

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ matrix.image }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH,MEDIUM
          vuln-type: os,library
          ignore-unfixed: true

      - name: Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif
          category: trivy-${{ hashFiles(matrix.image) }}

      - name: Scan image with Kubescape
        uses: kubescape/github-action@main
        continue-on-error: true
        with:
          image: ${{ matrix.image }}
          format: sarif
          outputFile: kubescape-results.sarif

      - name: Upload Kubescape scan results
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: kubescape-results.sarif
          category: kubescape-${{ hashFiles(matrix.image) }}
